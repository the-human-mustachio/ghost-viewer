#!/usr/bin/env node
import h from"express";import P from"cors";import p from"fs";import g from"path";import{fileURLToPath as _}from"url";import{ResourceGroupsTaggingAPIClient as x,GetResourcesCommand as F}from"@aws-sdk/client-resource-groups-tagging-api";var b=_(import.meta.url),E=g.dirname(b);function T(l={}){let r=h(),v=l.port||3001;r.use(P()),r.use(h.json());let m=process.cwd(),a=process.env.STATE_PATH||"";l.isDev&&(m=g.resolve(process.cwd(),"..")),r.get("/api/config",(o,t)=>{t.json({stateFile:a,projectRoot:m,exists:p.existsSync(a)})}),r.post("/api/config",(o,t)=>{let{stateFile:e}=o.body;e&&typeof e=="string"&&(a=e),t.json({stateFile:a,projectRoot:m,exists:p.existsSync(a)})}),r.get("/api/state",(o,t)=>{if(!p.existsSync(a))return t.status(404).json({error:"State file not found. Please set the path in Settings."});try{let e=p.readFileSync(a,"utf-8");t.json(JSON.parse(e))}catch(e){t.status(500).json({error:e.message})}}),r.post("/api/scan",async(o,t)=>{let{appName:e,stage:u,region:d}=o.body;if(!e||!u||!d)return t.status(400).json({error:"Missing required params: appName, stage, region"});try{let c=new Set;if(p.existsSync(a)){let s=JSON.parse(p.readFileSync(a,"utf-8"));(s.latest?.resources||s.checkpoint?.latest?.resources||s.deployment?.resources||[]).forEach(n=>{n.id&&c.add(n.id),n.outputs?.arn&&c.add(n.outputs.arn)})}let A=new x({region:d}),f=[],y;console.log(`Starting scan for App:${e} Stage:${u} in ${d}...`);do{let s=[];e!=="*"?s.push({Key:"sst:app",Values:[e]}):s.push({Key:"sst:app"}),u!=="*"?s.push({Key:"sst:stage",Values:[u]}):s.push({Key:"sst:stage"});let i=new F({TagFilters:s,PaginationToken:y}),n=await A.send(i);f=f.concat(n.ResourceTagMappingList||[]),y=n.PaginationToken}while(y);let N=f.filter(s=>{let i=s.ResourceARN||"";if(c.has(i))return!1;for(let n of c)if(i.endsWith(n))return!1;return!0}).map(s=>({arn:s.ResourceARN,type:s.ResourceARN?.split(":")[2],tags:s.Tags?.reduce((i,n)=>({...i,[n.Key]:n.Value}),{})||{},name:s.Tags?.find(i=>i.Key==="Name")?.Value||s.ResourceARN?.split(/[:/]/).pop()}));t.json({totalFound:f.length,orphans:N,managedCount:c.size})}catch(c){console.error(c),t.status(500).json({error:c.message})}});let R=g.resolve(E,"ui");r.use(h.static(R)),r.get("*",(o,t)=>{t.sendFile(g.join(R,"index.html"))});let S=o=>{let t=r.listen(o,async()=>{if(console.log(`Ghost Viewer running on http://localhost:${o}`),l.openBrowser){let e=(await import("open")).default;e(`http://localhost:${o}`)}});return t.on("error",e=>{e.code==="EADDRINUSE"?(console.log(`Port ${o} is in use, trying ${o+1}...`),S(o+1)):console.error("Server error:",e)}),t};return S(v)}var $=process.argv.slice(2),j=3001,w=$.find(l=>l.startsWith("--port="));w&&(j=parseInt(w.split("=")[1],10));console.log("Starting Ghost Viewer CLI...");T({port:j,openBrowser:!0,isDev:!1});
